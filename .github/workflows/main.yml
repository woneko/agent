name: Build + Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (e.g., v1.14.4)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    name: Checkout & Build
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout 当前公开仓库（触发 workflow 的 repo）
      - uses: actions/checkout@v4

      # 2️⃣ Checkout 私有仓库到 private-repo 目录
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}     # 私有仓库路径
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}    # PAT
          path: private-repo

      # 3️⃣ 设置 Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.2

      # 4️⃣ 进入私有仓库目录，go mod tidy
      - name: Go modules tidy
        working-directory: private-repo
        run: go mod tidy -v

      # 5️⃣ 使用 GoReleaser 构建
      - name: Build with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        working-directory: private-repo
        env:
          GOOS: linux
          GOARCH: amd64
        with:
          distribution: goreleaser
          version: "~> v2"
          args: build --single-target --clean --skip=validate --snapshot

      # 6️⃣ 打包
      - name: Archive
        working-directory: private-repo
        run: |
          zip -jr dist/nezha-agent_linux_amd64.zip dist/*/*

      # 7️⃣ 上传构建产物
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent_linux_amd64
          path: private-repo/dist/nezha-agent_linux_amd64.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./assets

      - name: Create tag
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}

      - name: Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.event.inputs.version }}
          artifacts: "assets/*/*.zip"
          generateReleaseNotes: true
