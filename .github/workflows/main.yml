name: Build + Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号，例如 v1.14.4'
        required: true
        default: 'v0.0.1'

jobs:
  tag-and-build:
    name: Tag, Build and Release
    runs-on: ubuntu-latest
    steps:
      # 设置 Git 用户
      - name: Set Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 创建 tag
      - name: Create tag
        run: |
          TAG=${{ github.event.inputs.version }}
          echo "Creating tag $TAG"
          git tag -a $TAG -m "Release $TAG"
          git push origin $TAG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 拉取私有仓库源码
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          fetch-depth: 0
          path: nezha-agent

      # 设置 Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.2

      # 构建 snapshot / release
      - name: Build with GoReleaser
        run: |
          cd nezha-agent
          TAG=${{ github.event.inputs.version }}
          if [[ "$TAG" == "" ]]; then
            goreleaser build --single-target --clean --skip=validate --snapshot
          else
            goreleaser build --single-target --clean --skip=validate
          fi
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOMIPS: ${{ matrix.gomips }}

      # 打包 zip
      - name: Archive binary
        run: |
          cd nezha-agent/dist
          BIN_NAME="nezha-agent"
          [[ "$GOOS" == "windows" ]] && BIN_NAME="nezha-agent.exe"
          zip -j "nezha-agent_${GOOS}_${GOARCH}.zip" "$BIN_NAME"

      # 上传 artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nezha-agent_${{ matrix.goos }}_${{ matrix.goarch }}
          path: nezha-agent/dist/nezha-agent_${{ matrix.goos }}_${{ matrix.goarch }}.zip

      # 创建 GitHub Release
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.event.inputs.version }}
          artifacts: "nezha-agent/dist/*.zip"
          generateReleaseNotes: true
          allowUpdates: true
